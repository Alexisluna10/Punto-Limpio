{% extends 'base_trabajador.html' %}

{% block title_page %}
Registrar Nuevo Servicio
{% endblock %}

{% block trabajador_content %}

<div class="modern-card" id="formContainer">

    <form id="servicioForm">
        {% csrf_token %}

        <div class="section-title">1. Datos del Cliente</div>

        <div class="form-row">
            <div class="form-group" style="flex: 3; position: relative;">
                <label>Buscar Cliente</label>
                <input type="text" class="input-modern" id="buscarCliente" placeholder="Nombre o Telefono..." autocomplete="off">
                <input type="hidden" id="clienteId" name="cliente_id">
                <div id="resultadosClientes" class="autocomplete-results" style="display: none;"></div>
                <div class="helper-text">Selecciona de la lista autocompletable</div>
            </div>
            <div class="form-group" style="flex: 1; justify-content: center;">
                <a href="{% url 'admin_nuevo_usuario' %}" class="btn-small">+ Registrar Cliente Nuevo</a>
            </div>
        </div>
        
        <div id="clienteSeleccionado" style="display: none; margin-bottom: 15px; padding: 10px; background: #e8f4fd; border-radius: 8px;">
            <strong>Cliente seleccionado:</strong> <span id="clienteNombre"></span>
            <button type="button" onclick="limpiarCliente()" style="margin-left: 10px; background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">X</button>
        </div>

        <div class="section-title">2. Detalles del Servicio</div>

        <div class="form-row">
            <div class="form-group">
                <label>Tipo de Servicio</label>
                <select class="input-modern" id="tipoServicioSelect" name="tipo_servicio" onchange="verificarServicio()">
                    <option value="por_encargo">Lavado por Encargo</option>
                    <option value="autoservicio">Autoservicio</option>
                    <option value="tintoreria">Tintoreria</option>
                    <option value="a_domicilio">A Domicilio</option>
                    <option value="planchado">Solo Planchado</option>
                </select>
            </div>

            <div class="form-group" id="divLavadoEspecial">
                <label>Lavado Especial?</label>
                <select class="input-modern" id="lavadoEspecial" name="lavado_especial">
                    <option value="no">No</option>
                    <option value="si">Si (Tenis, Mochilas, etc.)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Cobijas / Edredones</label>
                <select class="input-modern" id="cobijaTipo" name="cobija_tipo">
                    <option value="">Ninguna</option>
                    <option value="individual">Individual</option>
                    <option value="matrimonial">Matrimonial</option>
                    <option value="king_size">King Size</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Peso (Kg)</label>
                <input type="number" class="input-modern" id="peso" name="peso" placeholder="0.0" step="0.1">
            </div>
            <div class="form-group">
                <label>Cantidad de Prendas</label>
                <input type="number" class="input-modern" id="cantidadPrendas" name="cantidad_prendas" placeholder="0">
            </div>
        </div>

        <div class="form-group" style="margin-bottom: 25px;">
            <label>Observaciones</label>
            <textarea class="input-modern" id="observaciones" name="observaciones" rows="3" placeholder="Detalles de manchas, ropa delicada, etc."></textarea>
        </div>

        <div class="section-title">3. Pago y Entrega</div>

        <div class="form-row">
            <div class="form-group">
                <label>Fecha de Entrega</label>
                <input type="date" class="input-modern" id="fechaEntrega" name="fecha_entrega">
            </div>
            <div class="form-group">
                <label>Metodo de Pago</label>
                <select class="input-modern" id="metodoPago" name="metodo_pago">
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>
            <div class="form-group">
                <label>Total Estimado ($)</label>
                <input type="number" class="input-modern" id="totalEstimado" name="total" placeholder="0.00" step="0.01" min="0"
                    style="background-color: #e8f4fd; color: #008CC9; font-weight: bold; border-color: #b3dbf9;">
            </div>
        </div>

        <div class="buttons-container">
            <a href="{% url 'trabajador_dashboard' %}" class="btn-base btn-cancel">Cancelar</a>

            <button type="button" onclick="generarOrden()" class="btn-base btn-submit">Generar Orden</button>
        </div>

    </form>
</div>

<div id="pantallaExito" class="modal-overlay">
    <div class="success-icon-circle">
        <span class="success-checkmark">&#10004;</span>
    </div>
    <div class="success-title">
        Gracias por generar la Orden con exito!<br>
        <span id="folioGenerado" style="font-size: 0.8em; color: #008CC9;"></span>
    </div>
    <a href="{% url 'trabajador_dashboard' %}" class="btn-base btn-submit" style="min-width: 200px;">ACEPTAR</a>
</div>

<style>
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .autocomplete-item:hover {
        background-color: #f5f5f5;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .cliente-nombre {
        font-weight: bold;
        color: #333;
    }
    
    .cliente-telefono {
        font-size: 0.85em;
        color: #666;
    }
</style>

<script>
    let clienteSeleccionadoId = null;
    let timeoutBusqueda = null;
    
    // Busqueda de clientes con autocomplete
    document.getElementById('buscarCliente').addEventListener('input', function() {
        const query = this.value.trim();
        
        if (timeoutBusqueda) {
            clearTimeout(timeoutBusqueda);
        }
        
        if (query.length < 2) {
            document.getElementById('resultadosClientes').style.display = 'none';
            return;
        }
        
        timeoutBusqueda = setTimeout(() => {
            fetch('{% url "buscar_clientes" %}?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('resultadosClientes');
                    container.innerHTML = '';
                    
                    if (data.clientes.length === 0) {
                        container.innerHTML = '<div class="autocomplete-item" style="color: #666;">No se encontraron clientes</div>';
                    } else {
                        data.clientes.forEach(cliente => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            div.innerHTML = `
                                <div class="cliente-nombre">${cliente.nombre_completo} (@${cliente.username})</div>
                                <div class="cliente-telefono">Tel: ${cliente.telefono}</div>
                            `;
                            div.onclick = () => seleccionarCliente(cliente);
                            container.appendChild(div);
                        });
                    }
                    
                    container.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error buscando clientes:', error);
                });
        }, 300);
    });
    
    function seleccionarCliente(cliente) {
        clienteSeleccionadoId = cliente.id;
        document.getElementById('clienteId').value = cliente.id;
        document.getElementById('buscarCliente').value = cliente.nombre_completo;
        document.getElementById('clienteNombre').textContent = `${cliente.nombre_completo} (@${cliente.username}) - Tel: ${cliente.telefono}`;
        document.getElementById('clienteSeleccionado').style.display = 'block';
        document.getElementById('resultadosClientes').style.display = 'none';
    }
    
    function limpiarCliente() {
        clienteSeleccionadoId = null;
        document.getElementById('clienteId').value = '';
        document.getElementById('buscarCliente').value = '';
        document.getElementById('clienteSeleccionado').style.display = 'none';
    }
    
    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.form-group')) {
            document.getElementById('resultadosClientes').style.display = 'none';
        }
    });

    function verificarServicio() {
        var select = document.getElementById("tipoServicioSelect");
        var divEspecial = document.getElementById("divLavadoEspecial");

        if (select.value === "autoservicio") {
            divEspecial.style.visibility = "hidden";
            divEspecial.style.display = "none";
        } else {
            divEspecial.style.display = "flex";
            divEspecial.style.visibility = "visible";
        }
    }

    function generarOrden() {
        if (!clienteSeleccionadoId) {
            alert('Por favor selecciona un cliente');
            return;
        }
        
        const totalInput = document.getElementById('totalEstimado').value;
        const totalValue = parseFloat(totalInput) || 0;
        
        if (totalValue <= 0) {
            alert('Por favor ingresa el total estimado del servicio');
            return;
        }
        
        const datos = {
            cliente_id: clienteSeleccionadoId,
            tipo_servicio: document.getElementById('tipoServicioSelect').value,
            lavado_especial: document.getElementById('lavadoEspecial').value === 'si',
            cobija_tipo: document.getElementById('cobijaTipo').value,
            peso: parseFloat(document.getElementById('peso').value) || 0,
            cantidad_prendas: parseInt(document.getElementById('cantidadPrendas').value) || 0,
            observaciones: document.getElementById('observaciones').value,
            fecha_entrega: document.getElementById('fechaEntrega').value,
            metodo_pago: document.getElementById('metodoPago').value,
            total: totalValue
        };
        
        fetch('{% url "nuevo_servicio" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(datos)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("formContainer").style.display = "none";
                document.getElementById("folioGenerado").textContent = "Folio: " + data.folio;
                document.getElementById("pantallaExito").style.display = "flex";
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al generar la orden');
        });
    }
</script>

{% endblock %}
