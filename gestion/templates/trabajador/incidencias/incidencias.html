{% extends 'base_trabajador.html' %}

{% block title_page %}
Reportar Incidencia
{% endblock %}

{% block trabajador_content %}

<div class="trab-incidencias-layout">

    <!-- COLUMNA IZQUIERDA: Formulario -->
    <div class="trab-incidencia-form-container">
        <div class="trab-incidencia-encabezado">
            <h2 class="trab-incidencia-titulo">Reporte de Incidencias</h2>
            <p class="trab-incidencia-subtitulo">Complete el formulario para notificar al administrador</p>
        </div>

        <form class="trab-incidencia-form" id="formIncidencia" onsubmit="enviarReporte(event)">
            {% csrf_token %}
            
            <div class="form-row">
                <div class="trab-incidencia-grupo" style="flex: 2;">
                    <label class="trab-incidencia-label">Asunto del Problema</label>
                    <input type="text" name="asunto" class="trab-incidencia-input" placeholder="Ej: Falla en lavadora 5" required>
                </div>

                <div class="trab-incidencia-grupo" style="flex: 1;">
                    <label class="trab-incidencia-label">Prioridad</label>
                    <select name="prioridad" class="trab-incidencia-select">
                        <option value="baja">Baja</option>
                        <option value="media" selected>Media</option>
                        <option value="alta">Alta</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>
            </div>

            <div class="trab-incidencia-grupo">
                <label class="trab-incidencia-label">Descripci√≥n Detallada</label>
                <textarea name="descripcion" class="trab-incidencia-textarea"
                    placeholder="Describa qu√© sucedi√≥, qu√© m√°quina fall√≥ o qu√© insumo falta..." required></textarea>
            </div>

            <div class="trab-incidencia-grupo">
                <label class="trab-incidencia-label">Adjuntar Evidencia (Opcional)</label>
                <input type="file" name="evidencia" class="trab-incidencia-input" accept="image/*,.pdf">
            </div>

            <button type="submit" class="trab-incidencia-btn-enviar" id="btnEnviar">
                Enviar Reporte
            </button>
        </form>
    </div>

    <!-- COLUMNA DERECHA: Historial -->
    <div class="trab-incidencias-historial-container">
        <div class="historial-header">
            <h2>Mis Incidencias Reportadas</h2>
            <p>Aqu√≠ puedes ver tus reportes y las respuestas del administrador</p>
        </div>

        <div class="historial-lista">
            {% if mis_incidencias %}
            {% for incidencia in mis_incidencias %}
            <div class="incidencia-card {% if incidencia.estado == 'resuelto' %}incidencia-resuelta{% endif %}">
                <div class="incidencia-header-card">
                    <span class="incidencia-fecha">{{ incidencia.fecha_reporte|date:"d/m/Y H:i" }}</span>
                    <span class="incidencia-prioridad prioridad-{{ incidencia.prioridad }}">
                        {{ incidencia.get_prioridad_display }}
                    </span>
                    <span class="incidencia-estado estado-{{ incidencia.estado }}">
                        {{ incidencia.get_estado_display }}
                    </span>
                </div>

                <div class="incidencia-asunto">
                    <strong>üìã Asunto:</strong>
                    <p>{{ incidencia.asunto }}</p>
                </div>

                <div class="incidencia-descripcion">
                    <strong>Tu reporte:</strong>
                    <p>{{ incidencia.descripcion }}</p>
                </div>

                {% if incidencia.evidencia %}
                <div class="incidencia-evidencia">
                    <strong>üìé Evidencia adjunta:</strong>
                    <a href="{{ incidencia.evidencia.url }}" target="_blank" class="ver-evidencia">
                        Ver archivo
                    </a>
                </div>
                {% endif %}

                {% if incidencia.respuesta %}
                <div class="incidencia-respuesta">
                    <strong>‚úÖ Respuesta del Administrador:</strong>
                    <p>{{ incidencia.respuesta }}</p>
                    {% if incidencia.fecha_resolucion %}
                    <small class="fecha-respuesta">
                        Respondido el {{ incidencia.fecha_resolucion|date:"d/m/Y H:i" }}
                    </small>
                    {% endif %}
                </div>
                {% else %}
                <div class="incidencia-sin-respuesta">
                    <em>‚è≥ Esperando respuesta del administrador...</em>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="sin-incidencias">
                <p>A√∫n no has reportado ninguna incidencia.</p>
                <p>Utiliza el formulario de la izquierda para enviar tu primer reporte.</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<div id="modalIncidencia" class="modal-overlay">
    <div class="modern-card" style="text-align: center; max-width: 500px; padding: 50px;">

        <div class="success-icon-circle" style="margin: 0 auto 30px auto; background-color: #008CC9;">
            <span class="success-checkmark">&#10003;</span>
        </div>

        <h3 class="success-title">¬°REPORTE ENVIADO!</h3>

        <p class="trab-modal-texto">
            GRACIAS POR ENVIAR LA INCIDENCIA, EL ADMINISTRADOR TOMAR√Å CARTAS SOBRE EL ASUNTO.
        </p>

        <button class="btn-accept" onclick="cerrarModal()">ENTENDIDO</button>
    </div>
</div>

<script>
    function enviarReporte(event) {
        event.preventDefault();
        
        const form = document.getElementById('formIncidencia');
        const formData = new FormData(form);
        const btnEnviar = document.getElementById('btnEnviar');
        
        // Deshabilitar bot√≥n durante el env√≠o
        btnEnviar.disabled = true;
        btnEnviar.textContent = 'Enviando...';
        
        fetch('{% url "incidencias" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar modal de √©xito
                const modal = document.getElementById('modalIncidencia');
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.add('open');
                }, 10);
            } else {
                alert('Error: ' + data.message);
                btnEnviar.disabled = false;
                btnEnviar.textContent = 'Enviar Reporte';
            }
        })
        .catch(error => {
            alert('Error al enviar la incidencia. Por favor intenta de nuevo.');
            console.error('Error:', error);
            btnEnviar.disabled = false;
            btnEnviar.textContent = 'Enviar Reporte';
        });
    }

    function cerrarModal() {
        const modal = document.getElementById('modalIncidencia');
        modal.classList.remove('open');
        setTimeout(() => {
            modal.style.display = 'none';
            // Recargar la p√°gina para mostrar la nueva incidencia
            window.location.reload();
        }, 300);
    }
</script>

{% endblock %}