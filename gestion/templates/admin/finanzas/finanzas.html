{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Finanzas - Panel Administrador{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .finanzas-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Filtros de fecha */
    .filtros-fecha {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }

    .filtros-rapidos {
        display: flex;
        gap: 10px;
    }

    .filtros-rapidos a {
        padding: 10px 20px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        color: #333;
    }

    .filtros-rapidos a:hover,
    .filtros-rapidos a.active {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }

    .filtro-personalizado {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filtro-personalizado input[type="date"] {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .filtro-personalizado .btn-filtrar {
        padding: 8px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    /* Tarjetas de resumen */
    .resumen-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .tarjeta-resumen {
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 20px;
    }

    .tarjeta-resumen h3 {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 15px;
        text-transform: uppercase;
    }

    .linea-resumen {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
    }

    .linea-resumen.total {
        border-top: 1px solid #333;
        margin-top: 10px;
        padding-top: 15px;
        font-weight: bold;
    }

    .valor-positivo {
        color: #28a745;
    }

    .valor-negativo {
        color: #dc3545;
    }

    /* Gráficas */
    .graficas-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .grafica-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 20px;
    }

    .grafica-container.full-width {
        grid-column: span 2;
    }

    .grafica-container h3 {
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 15px;
        text-transform: uppercase;
    }

    .grafica-content {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        min-height: 250px;
    }

    .chart-wrapper {
        position: relative;
        width: 100%;
        max-width: 350px;
        margin: 0 auto;
    }

    .chart-wrapper-bar {
        position: relative;
        width: 100%;
        height: 300px;
    }

    .grafica-descripcion {
        text-align: center;
        color: #666;
        font-size: 12px;
        margin-top: 15px;
    }

    .sin-datos {
        text-align: center;
        color: #999;
        padding: 40px;
        font-style: italic;
    }

    /* Acciones rápidas */
    .acciones-rapidas {
        margin-bottom: 30px;
    }

    .acciones-rapidas h4 {
        font-weight: bold;
        margin-bottom: 15px;
    }

    .acciones-buttons {
        display: flex;
        gap: 10px;
    }

    .acciones-buttons button {
        padding: 10px 20px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 5px;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Navegación inferior */
    .navegacion-inferior {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    .navegacion-inferior button {
        padding: 12px 30px;
        border: 1px solid #333;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
    }

    .navegacion-inferior button:hover {
        background: #f5f5f5;
    }

    .navegacion-inferior button.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .periodo-actual {
        text-align: center;
        font-size: 13px;
        color: #666;
        margin-bottom: 20px;
    }

    @media (max-width: 992px) {
        .resumen-grid,
        .graficas-grid {
            grid-template-columns: 1fr;
        }
        .grafica-container.full-width {
            grid-column: span 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="finanzas-container">
    <!-- Filtros de fecha -->
    <div class="filtros-fecha">
        <div class="filtros-rapidos">
            <a href="?filtro=hoy" class="{% if filtro == 'hoy' %}active{% endif %}">Hoy</a>
            <a href="?filtro=semana" class="{% if filtro == 'semana' %}active{% endif %}">Esta semana</a>
            <a href="?filtro=mes" class="{% if filtro == 'mes' %}active{% endif %}">Este mes</a>
            <a href="#" id="btn-personalizado" class="{% if filtro == 'personalizado' %}active{% endif %}">Personalizado</a>
        </div>
        <form class="filtro-personalizado" id="form-personalizado" method="GET">
            <input type="hidden" name="filtro" value="personalizado">
            <span>[Desde:</span>
            <input type="date" name="fecha_desde" id="fecha_desde" value="{{ fecha_inicio|date:'Y-m-d' }}">
            <span>] [Hasta:</span>
            <input type="date" name="fecha_hasta" id="fecha_hasta" value="{{ fecha_fin|date:'Y-m-d' }}">
            <span>]</span>
            <button type="submit" class="btn-filtrar">[Filtrar]</button>
        </form>
    </div>

    <div class="periodo-actual">
        Mostrando datos del <strong>{{ fecha_inicio|date:'d/m/Y' }}</strong> al <strong>{{ fecha_fin|date:'d/m/Y' }}</strong>
    </div>

    <!-- Tarjetas de resumen -->
    <div class="resumen-grid">
        <div class="tarjeta-resumen">
            <h3>RESUMEN FINANCIERO</h3>
            <div class="linea-resumen">
                <span>Ingresos totales:</span>
                <span>${{ ingresos_totales|floatformat:2 }}</span>
            </div>
            <div class="linea-resumen">
                <span>Gastos en insumos:</span>
                <span class="valor-negativo">-${{ gastos_insumos|floatformat:2 }}</span>
            </div>
            <div class="linea-resumen">
                <span>Gastos operativos:</span>
                <span class="valor-negativo">-${{ gastos_operativos_total|floatformat:2 }}</span>
            </div>
            <div class="linea-resumen total">
                <span>UTILIDAD NETA:</span>
                <span class="{% if utilidad_neta >= 0 %}valor-positivo{% else %}valor-negativo{% endif %}">
                    ${{ utilidad_neta|floatformat:2 }}
                </span>
            </div>
        </div>

        <div class="tarjeta-resumen">
            <h3 style="text-align: right;">DESGLOSE POR METODO DE PAGO</h3>
            <div class="linea-resumen">
                <span>Efectivo:</span>
                <span>${{ pago_efectivo|floatformat:2 }} ({{ pct_efectivo }}%)</span>
            </div>
            <div class="linea-resumen">
                <span>Tarjeta:</span>
                <span>${{ pago_tarjeta|floatformat:2 }} ({{ pct_tarjeta }}%)</span>
            </div>
            <div class="linea-resumen">
                <span>Transferencia:</span>
                <span>${{ pago_transferencia|floatformat:2 }} ({{ pct_transferencia }}%)</span>
            </div>
        </div>
    </div>

    <!-- Gráficas -->
    <div class="graficas-grid">
        <!-- Gráfica 1: Tendencias de Prendas -->
        <div class="grafica-container">
            <h3>TENDENCIAS DE PRENDAS</h3>
            <div class="grafica-content">
                <div class="chart-wrapper">
                    <canvas id="chartPrendas"></canvas>
                </div>
            </div>
            <p class="grafica-descripcion">
                Las prendas que mas se lavan y sus porcentajes
            </p>
        </div>

        <!-- Gráfica 2: Ganancias por Prenda -->
        <div class="grafica-container">
            <h3>GANANCIAS POR PRENDA</h3>
            <div class="chart-wrapper-bar">
                <canvas id="chartGananciasPrendas"></canvas>
            </div>
            <p class="grafica-descripcion">
                Ganancias generadas por cada tipo de prenda
            </p>
        </div>

        <!-- Gráfica 3: Servicios más usados -->
        <div class="grafica-container">
            <h3>SERVICIOS MAS USADOS</h3>
            <div class="grafica-content">
                <div class="chart-wrapper">
                    <canvas id="chartServicios"></canvas>
                </div>
            </div>
            <p class="grafica-descripcion">
                Los servicios que mas se solicitan
            </p>
        </div>

        <!-- Gráfica 4: Ganancias por Servicio -->
        <div class="grafica-container">
            <h3>GANANCIAS POR SERVICIO</h3>
            <div class="chart-wrapper-bar">
                <canvas id="chartGananciasServicios"></canvas>
            </div>
            <p class="grafica-descripcion">
                Ganancias generadas por cada servicio
            </p>
        </div>

        <!-- Gráfica 5: Métodos de Pago -->
        <div class="grafica-container">
            <h3>METODOS DE PAGO</h3>
            <div class="grafica-content">
                <div class="chart-wrapper">
                    <canvas id="chartMetodosPago"></canvas>
                </div>
            </div>
            <p class="grafica-descripcion">
                Distribucion de ganancias por metodo de pago
            </p>
        </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="acciones-rapidas">
        <h4>ACCIONES RAPIDAS</h4>
        <div class="acciones-buttons">
            <button onclick="exportarExcel()" style="cursor: pointer; opacity: 1; background: #28a745; color: white;">Exportar a Excel</button>
            <button onclick="imprimirReporte()" style="cursor: pointer; opacity: 1; background: #007bff; color: white;">Imprimir Reporte</button>
            <button disabled>* Enviar por Email</button>
        </div>
    </div>

    <!-- Navegación inferior -->
    <div class="navegacion-inferior">
        <button class="disabled">Resumen</button>
        <button class="disabled">Ingresos</button>
        <button class="disabled">Gastos</button>
        <button onclick="window.location.href='{% url 'admin_corte_caja' %}'">Corte de Caja</button>
    </div>
</div>

<script>
    // Colores para las gráficas
    const coloresPie = [
        '#2d3748', '#4a5568', '#718096', '#a0aec0', '#cbd5e0', '#e2e8f0',
        '#1a202c', '#2c5282', '#2b6cb0', '#3182ce'
    ];
    
    const coloresBar = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6610f2', '#6f42c1'
    ];

    // Datos desde Django
    const prendasData = {{ prendas_json|safe }};
    const serviciosData = {{ servicios_json|safe }};
    const insumosData = {{ insumos_json|safe }};
    const gastosOperativosData = {{ gastos_operativos_json|safe }};
    const metodosPagoData = {{ metodos_pago_json|safe }};

    // Función para formatear moneda
    function formatCurrency(value) {
        return '$' + value.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Gráfica 1: Tendencias de Prendas (Pie)
    if (prendasData.length > 0) {
        new Chart(document.getElementById('chartPrendas'), {
            type: 'pie',
            data: {
                labels: prendasData.map(p => p.nombre + ' ' + p.porcentaje + '%'),
                datasets: [{
                    data: prendasData.map(p => p.cantidad),
                    backgroundColor: coloresPie.slice(0, prendasData.length)
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 11 } }
                    }
                }
            }
        });
    } else {
        document.getElementById('chartPrendas').parentElement.innerHTML = '<p class="sin-datos">Sin datos para mostrar</p>';
    }

    // Gráfica 2: Ganancias por Prenda (Bar)
    if (prendasData.length > 0) {
        new Chart(document.getElementById('chartGananciasPrendas'), {
            type: 'bar',
            data: {
                labels: prendasData.map(p => p.nombre),
                datasets: [{
                    label: 'Ganancias',
                    data: prendasData.map(p => p.ganancia),
                    backgroundColor: '#28a745'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('chartGananciasPrendas').parentElement.innerHTML = '<p class="sin-datos">Sin datos para mostrar</p>';
    }

    // Gráfica 3: Servicios más usados (Pie)
    if (serviciosData.length > 0) {
        new Chart(document.getElementById('chartServicios'), {
            type: 'pie',
            data: {
                labels: serviciosData.map(s => s.nombre + ' ' + s.porcentaje + '%'),
                datasets: [{
                    data: serviciosData.map(s => s.cantidad),
                    backgroundColor: coloresPie.slice(0, serviciosData.length)
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 11 } }
                    }
                }
            }
        });
    } else {
        document.getElementById('chartServicios').parentElement.innerHTML = '<p class="sin-datos">Sin datos para mostrar</p>';
    }

    // Gráfica 4: Ganancias por Servicio (Bar)
    if (serviciosData.length > 0) {
        new Chart(document.getElementById('chartGananciasServicios'), {
            type: 'bar',
            data: {
                labels: serviciosData.map(s => s.nombre),
                datasets: [{
                    label: 'Ganancias',
                    data: serviciosData.map(s => s.ganancia),
                    backgroundColor: '#17a2b8'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('chartGananciasServicios').parentElement.innerHTML = '<p class="sin-datos">Sin datos para mostrar</p>';
    }

    // Gráfica 5: Métodos de Pago (Doughnut)
    if (metodosPagoData.some(m => m.total > 0)) {
        new Chart(document.getElementById('chartMetodosPago'), {
            type: 'doughnut',
            data: {
                labels: metodosPagoData.map(m => m.nombre + ' ' + m.porcentaje + '%'),
                datasets: [{
                    data: metodosPagoData.map(m => m.total),
                    backgroundColor: ['#28a745', '#007bff', '#ffc107']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.raw);
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('chartMetodosPago').parentElement.innerHTML = '<p class="sin-datos">Sin datos para mostrar</p>';
    }

    // Mostrar/ocultar filtro personalizado
    document.getElementById('btn-personalizado').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('form-personalizado').style.display = 'flex';
        document.querySelectorAll('.filtros-rapidos a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
    });

    // Función para exportar a Excel
    function exportarExcel() {
        // Obtener los parámetros actuales de filtro
        const urlParams = new URLSearchParams(window.location.search);
        const filtro = urlParams.get('filtro') || 'hoy';
        const fechaDesde = urlParams.get('fecha_desde') || '';
        const fechaHasta = urlParams.get('fecha_hasta') || '';
        
        // Construir la URL con los parámetros
        let url = '{% url "exportar_finanzas_excel" %}?filtro=' + filtro;
        if (filtro === 'personalizado' && fechaDesde && fechaHasta) {
            url += '&fecha_desde=' + fechaDesde + '&fecha_hasta=' + fechaHasta;
        }
        
        // Abrir en nueva ventana para descargar
        window.location.href = url;
    }

    // Función para imprimir reporte
    function imprimirReporte() {
        // Obtener los parámetros actuales de filtro
        const urlParams = new URLSearchParams(window.location.search);
        const filtro = urlParams.get('filtro') || 'hoy';
        const fechaDesde = urlParams.get('fecha_desde') || '';
        const fechaHasta = urlParams.get('fecha_hasta') || '';
        
        // Construir la URL con los parámetros
        let url = '{% url "imprimir_reporte_finanzas" %}?filtro=' + filtro;
        if (filtro === 'personalizado' && fechaDesde && fechaHasta) {
            url += '&fecha_desde=' + fechaDesde + '&fecha_hasta=' + fechaHasta;
        }
        
        // Abrir en nueva ventana para visualizar/imprimir el PDF
        window.open(url, '_blank');
    }
</script>
{% endblock %}